<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Sri Hanumaan Trader's Lucky Draw</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        h1 { color: #FFD700; margin-bottom: 20px; }
        .btn-custom { background: #FFD700; color: #000; border: none; padding: 10px 15px; margin: 5px; border-radius: 5px; cursor: pointer; }
        table { width: 100%; background: #fff; color: #000; margin-top: 20px; border-radius: 5px; }
        th, td { padding: 10px; border: 1px solid #ddd; }
        #winnerName { font-size: 2rem; color: #FFD700; margin-top: 20px; animation: glow 1.5s infinite alternate; }
        @keyframes glow { from { text-shadow: 0 0 10px #FFD700; } to { text-shadow: 0 0 20px #FFD700; } }
        #countdown { font-size: 4rem; color: #FF6347; margin: 20px 0; }
        #prizeTitle { font-size: 2rem; color: #00FF00; margin-top: 20px; }
    </style>
</head>
<body>

<h1>Sri Hanumaan Trader's Lucky Draw</h1>

<button class="btn-custom" onclick="toggleAdminPanel()">Admin Panel</button>
<button class="btn-custom" onclick="startDraw()">Start Lucky Draw</button>
<button class="btn-custom" onclick="exportPDF()">Export PDF</button>
<button class="btn-custom" onclick="exportExcel()">Export Excel</button>

<!-- Admin Panel -->
<div id="adminPanel" class="hidden">
    <h2>Manage Participants</h2>
    <input type="text" id="participantName" placeholder="Enter Name" class="form-control mb-2">
    <input type="text" id="traderAddress" placeholder="Enter Trader Address" class="form-control mb-2">
    <button class="btn-custom" onclick="addParticipant()">Add</button>

    <table id="participantTable" class="table table-bordered mt-3">
        <thead>
            <tr><th>S. No</th><th>Name</th><th>Trader Address</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Lucky Draw Section -->
<div id="drawSection" class="hidden">
    <h2>Lucky Draw Winner</h2>
    <div id="prizeTitle"></div>
    <div id="countdown"></div>
    <div id="winnerName"></div>
</div>

<audio id="winSound">
    <source src="win-sound.mp3" type="audio/mpeg">
</audio>

<script>
    let participants = JSON.parse(localStorage.getItem('participants')) || [];
    let winners = [];
    
    // Prize structure with winner counts
    const prizes = [
        { prize: '1st Prize - 6 Gram Gold', count: 1 },
        { prize: '2nd Prize - 4 Gram Gold', count: 2 },
        { prize: '3rd Prize - 3 Gram Gold', count: 1 },
        { prize: '4th Prize - 2 Gram Gold', count: 1 },
        { prize: '5th Prize - 1 Gram Gold', count: 1 },
        { prize: '6th Prize - 0.5 Gram Silver', count: 1 }
    ];
    
    let currentPrizeIndex = 0;

    // Show Admin Panel
    function toggleAdminPanel() {
        document.getElementById('adminPanel').classList.toggle('hidden');
        renderTable();
    }

    // Add Participant
    function addParticipant() {
        const name = document.getElementById('participantName').value.trim();
        const traderAddress = document.getElementById('traderAddress').value.trim();
        if (name && traderAddress) {
            participants.push({ name, traderAddress });
            localStorage.setItem('participants', JSON.stringify(participants));
            renderTable();
            document.getElementById('participantName').value = '';
            document.getElementById('traderAddress').value = '';
        } else {
            alert("Enter both Name and Trader Address!");
        }
    }

    // Render Participant Table
    function renderTable() {
        const tbody = document.querySelector('#participantTable tbody');
        tbody.innerHTML = '';
        participants.forEach((p, i) => {
            tbody.innerHTML += `<tr>
                <td>${i + 1}</td>
                <td>${p.name}</td>
                <td>${p.traderAddress}</td>
                <td><button class="btn btn-danger btn-sm" onclick="deleteParticipant(${i})">Delete</button></td>
            </tr>`;
        });
    }

    // Delete Participant
    function deleteParticipant(index) {
        participants.splice(index, 1);
        localStorage.setItem('participants', JSON.stringify(participants));
        renderTable();
    }

    // Start Draw
    function startDraw() {
        if (participants.length === 0) {
            alert("No participants for the draw!");
            return;
        }
        document.getElementById('drawSection').classList.remove('hidden');
        drawPrize();
    }

    // Draw Prize
    function drawPrize() {
        if (currentPrizeIndex >= prizes.length) {
            alert("All prizes drawn!");
            return;
        }

        const prize = prizes[currentPrizeIndex];
        document.getElementById('prizeTitle').innerText = prize.prize;

        let countdown = 5;
        const countdownEl = document.getElementById('countdown');
        countdownEl.innerText = countdown;

        const interval = setInterval(() => {
            countdown--;
            countdownEl.innerText = countdown;
            if (countdown === 0) {
                clearInterval(interval);
                announceWinner(prize);
            }
        }, 1000);
    }

    // Announce Winner
    function announceWinner(prize) {
        let winnersList = [];
        for (let i = 0; i < prize.count; i++) {
            const winnerIndex = Math.floor(Math.random() * participants.length);
            const winner = participants.splice(winnerIndex, 1)[0];
            winnersList.push(`${winner.name} - ${winner.traderAddress}`);
            winners.push({ prize: prize.prize, ...winner });
        }
        localStorage.setItem('winners', JSON.stringify(winners));
        document.getElementById('winnerName').innerText = `ðŸŽ‰ ${winnersList.join('\nðŸŽ‰ ')}`;
        document.getElementById('winSound').play();
        currentPrizeIndex++;
    }

    // Export PDF
    function exportPDF() {
        const docDefinition = {
            content: ['Lucky Draw Winners\n\n'],
        };
        winners.forEach(w => docDefinition.content.push(`${w.prize}: ${w.name} - ${w.traderAddress}\n`));
        pdfMake.createPdf(docDefinition).download('winners.pdf');
    }

    // Export Excel (CSV)
    function exportExcel() {
        let csvContent = "data:text/csv;charset=utf-8,Prize,Name,Trader Address\n";
        winners.forEach(w => csvContent += `${w.prize},${w.name},${w.traderAddress}\n`);
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "winners.csv");
        document.body.appendChild(link);
        link.click();
    }

    // Init
    renderTable();
</script>

</body>
</html>
