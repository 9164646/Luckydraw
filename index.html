<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Sri Hanumaan Trader's Lucky Draw</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        h1 { color: #FFD700; margin-bottom: 20px; }
        .btn-custom { background: #FFD700; color: #000; border: none; padding: 10px 15px; margin: 5px; border-radius: 5px; cursor: pointer; }
        table { width: 100%; background: #fff; color: #000; margin-top: 20px; border-radius: 5px; }
        th, td { padding: 10px; border: 1px solid #ddd; }
        #winnerName { font-size: 2rem; color: #FFD700; margin-top: 20px; animation: glow 1.5s infinite alternate; }
        @keyframes glow { from { text-shadow: 0 0 10px #FFD700; } to { text-shadow: 0 0 20px #FFD700; } }
        #countdown { font-size: 4rem; color: #FF6347; margin: 20px 0; }
        #prizeTitle { font-size: 2rem; color: #00FF00; margin-top: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<h1>Sri Hanumaan Trader's Lucky Draw</h1>

<button class="btn-custom" onclick="toggleAdminPanel()">Admin Panel</button>
<button class="btn-custom" onclick="startDraw()">Start Lucky Draw</button>
<button class="btn-custom" onclick="exportWinnersPDF()">Download PDF</button>
<button class="btn-custom" onclick="exportWinnersExcel()">Download Excel</button>

<!-- Admin Panel -->
<div id="adminPanel" class="hidden">
    <h2>Manage Participants</h2>
    <input type="text" id="participantName" placeholder="Enter Name" class="form-control mb-2">
    <input type="text" id="traderAddress" placeholder="Enter Trader Address" class="form-control mb-2">
    <button class="btn-custom" onclick="addParticipant()">Add/Update</button>

    <table id="participantTable" class="table table-bordered mt-3">
        <thead>
            <tr><th>S. No</th><th>Name</th><th>Trader Address</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Lucky Draw Section -->
<div id="drawSection" class="hidden">
    <h2>Lucky Draw Winner</h2>
    <div id="prizeTitle"></div>
    <div id="countdown"></div>
    <div id="winnerName"></div>
</div>

<script>
    let participants = JSON.parse(localStorage.getItem('participants')) || [];
    let winners = JSON.parse(localStorage.getItem('winners')) || [];
    let editIndex = -1;

    const prizes = [
        { prize: '1st Prize - 6 Gram Gold', count: 1 },
        { prize: '2nd Prize - 4 Gram Gold', count: 2 }
    ];

    let currentPrizeIndex = 0;

    // Toggle Admin Panel
    function toggleAdminPanel() {
        const adminPanel = document.getElementById('adminPanel');
        const drawSection = document.getElementById('drawSection');
        adminPanel.classList.toggle('hidden');
        drawSection.classList.add('hidden');
        renderTable();
    }

    // Add Participant
    function addParticipant() {
        const name = document.getElementById('participantName').value.trim();
        const traderAddress = document.getElementById('traderAddress').value.trim();
        if (name && traderAddress) {
            if (editIndex === -1) {
                participants.push({ name, traderAddress });
            } else {
                participants[editIndex] = { name, traderAddress };
                editIndex = -1;
            }
            localStorage.setItem('participants', JSON.stringify(participants));
            renderTable();
            clearInputs();
        } else {
            alert("Please enter both Name and Trader Address.");
        }
    }

    // Render Participant Table
    function renderTable() {
        const tbody = document.querySelector('#participantTable tbody');
        tbody.innerHTML = '';
        participants.forEach((p, i) => {
            tbody.innerHTML += `<tr>
                <td>${i + 1}</td>
                <td>${p.name}</td>
                <td>${p.traderAddress}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editParticipant(${i})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteParticipant(${i})">Delete</button>
                </td>
            </tr>`;
        });
    }

    // Start Lucky Draw
    function startDraw() {
        const prize = prizes[currentPrizeIndex];
        if (!prize) {
            alert("All prizes drawn!");
            return;
        }

        const eligibleParticipants = participants.filter(p => !winners.find(w => w.name === p.name));
        if (eligibleParticipants.length < prize.count) {
            alert("Not enough participants left for this prize!");
            return;
        }

        const selectedWinners = [];
        for (let i = 0; i < prize.count; i++) {
            const randomIndex = Math.floor(Math.random() * eligibleParticipants.length);
            selectedWinners.push(eligibleParticipants.splice(randomIndex, 1)[0]);
        }

        selectedWinners.forEach(w => winners.push({ ...w, prize: prize.prize }));
        localStorage.setItem('winners', JSON.stringify(winners));

        // Show winner names
        document.getElementById('drawSection').classList.remove('hidden');
        document.getElementById('prizeTitle').textContent = prize.prize;
        document.getElementById('winnerName').textContent = selectedWinners.map(w => w.name).join(", ");
        currentPrizeIndex++;
    }

    // Export Winners PDF
    function exportWinnersPDF() {
        const docDefinition = { content: ['Sri Hanumaan Trader\'s Lucky Draw Winners\n\n'] };
        winners.forEach((w, index) => {
            docDefinition.content.push(`${index + 1}. ${w.name} - ${w.traderAddress} (${w.prize})\n`);
        });
        pdfMake.createPdf(docDefinition).download('winners.pdf');
    }

    // Export Winners Excel (CSV)
    function exportWinnersExcel() {
        let csvContent = "No,Name,Trader Address,Prize\n";
        winners.forEach((w, index) => {
            csvContent += `${index + 1},${w.name},${w.traderAddress},${w.prize}\n`;
        });
        const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "winners.csv");
        document.body.appendChild(link);
        link.click();
    }

    function clearInputs() {
        document.getElementById('participantName').value = '';
        document.getElementById('traderAddress').value = '';
    }

    renderTable();
</script>

</body>
</html>
